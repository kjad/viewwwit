<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Viewwwit</title>
  <style>
   .grid-item {
     float: left;
     margin: 0 10px 10px auto;
   }
   img {
     width: 400px;
   }
   html {
     width: 100%;
     height: 100%;
   }
   body {
     width: 100%;
     height: 100%;
     padding-top: 50px;
   }
   #vue-app {
     margin: 0 auto;
     width: 100%;
     height: 100%;
   }
  </style>
  <meta name="description" content="A simple reddit image viewer.">
  <meta name="viewport" content="width=device-width">

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">

</head>
<body>

  <div id="vue-app">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Viewwwit</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">r/pics <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="grid js-masonry">
      <div class="grid-item">
        <img src="http://placehold.it/400x1">
      </div>
      <div class="grid-item" v-for="item in items">
        <img v-bind:src="item" />
      </div>
    </div>

    <pre>{{ $data | json }}</pre>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.12/vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/0.5.1/vue-resource.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/3.3.2/masonry.pkgd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.2.0/imagesloaded.js"></script>

  <script type="text/javascript">
    var $grid = $('.grid').masonry({
      itemSelector: '.grid-item',
      gutter: 10,
      isOriginLeft: false
    });

    new Vue({
      el: '#vue-app',

      data: {
        currentPage: 0,
        items: []
      },

      ready: function() {
        this.loadPosts();
      },

      methods: {
        loadPosts: function(){
          this.$http.get('https://www.reddit.com/r/adviceanimals/.json', {'page': this.currentPage}, function(response) {
            this.$set('items', this.cleanupUrl(response));
            this.currentPage += 25;
            console.log("Waiting for next Tick");
            this.$nextTick(function() {
              console.log("Next Tick.");
              this.initMasonry();
            })
          }.bind(this));
        },

        cleanupUrl: function(response) {

          var urls = [];

          for (var i = 0; i < response.data.children.length; i++) {
            var post = response.data.children[i].data;
            var url = post.url;

            if (post.domain.match(/imgur/) && !url.match(/jpg|png|gif$/)) {

              url += 'l.jpg';
              urls.push(url);

            } else if (post.domain.match(/quickmeme.com/)) {

              var parts = post.url.split('/');
              var qkid = parts[parts.length - 2];
              url = 'http://i.qkme.me/' + qkid + '.jpg';
              urls.push(url);

            }

          }

          return urls;

        },

        initMasonry: function() {
          $grid.imagesLoaded(function() {
            $grid.masonry('appended', $('.grid-item'));
          })
        }

      }
    })

  </script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38155216-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</body>
</html>
